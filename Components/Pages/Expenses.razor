@page "/view-expenses"
@using DotnetCourseowork.Models
@inject UserService UserService
@inject NavigationManager NavigationManager

<div class="container my-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary">Manage Expenses</h3>
        <button class="btn btn-outline-primary" @onclick="NavigateToHome">
            Back to Home
        </button>
    </div>

    <!-- Filters Section -->
    <div class="card p-3 mb-4">
        <h5 class="mb-3 text-secondary">Filter Expenses</h5>
        <div class="d-flex flex-wrap gap-2 mb-3">
            <button class="btn btn-success" @onclick="ShowCreditExpenses">Cash Inflow </button>
            <button class="btn btn-danger" @onclick="ShowDebitExpenses">Cash Outflow</button>
            <button class="btn btn-secondary" @onclick="ShowAllExpenses">All Expenses</button>
        </div>

        <h6 class="text-secondary mb-3">Filter by Amount</h6>
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="number" class="form-control" placeholder="Min Amount" @bind="minAmount" />
            </div>
            <div class="col-md-6">
                <input type="number" class="form-control" placeholder="Max Amount" @bind="maxAmount" />
            </div>
        </div>

        <h6 class="text-secondary mb-3">Filter by Date</h6>
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="date" class="form-control" @bind="startDate" />
            </div>
            <div class="col-md-6">
                <input type="date" class="form-control" @bind="endDate" />
            </div>
        </div>

        <h6 class="text-secondary mb-3">Filter by Description</h6>
        <input type="text" class="form-control mb-3" placeholder="Search by Description" @bind="descriptionFilter" />

        <div>
            <button class="btn btn-primary me-2" @onclick="ApplyFilters">Apply Filters</button>
            <button class="btn btn-warning" @onclick="ClearFilters">Clear Filters</button>
        </div>
    </div>

    <!-- Sort by Date Button -->
    <button  @onclick="SortByDate">Sort by Date</button>

    <!-- Expenses Table -->
    <div class="card p-3">
        <h5 class="text-secondary mb-3">Expense Details</h5>
        <table class="table table-bordered table-striped">
            <thead class="thead-dark">
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Expense Type</th>
                    <th>Expense Tag</th> <!-- Added column for Expense Tag -->
                </tr>
            </thead>
            <tbody>
                @if (filteredExpenses.Count > 0)
                {
                    @foreach (var expense in filteredExpenses)
                    {
                        <tr>
                            <td>@expense.Date.ToString()</td>
                            <td>@expense.Description</td>
                            <td>$@expense.Amount</td>
                            <td>@expense.ExpenseType</td>
                            <td>@expense.ExpenseTag</td> <!-- Added cell for Expense Tag -->
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center">No expenses available.</td> <!-- Updated colspan -->
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private List<Expense> expenses = new List<Expense>();
    private List<Expense> filteredExpenses = new List<Expense>();

    private decimal? minAmount;
    private decimal? maxAmount;
    private DateTime? startDate;
    private DateTime? endDate;
    private string descriptionFilter;

    private bool isDateAscending = true; // Track the sort order

    protected override async Task OnInitializedAsync()
    {
        try
        {
            expenses = UserService.GetUserExpenses();
            filteredExpenses = expenses; // Initially display all expenses
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching expenses: {ex.Message}");
        }
    }

    private void ShowCreditExpenses()
    {
        filteredExpenses = expenses.Where(e => e.ExpenseType.Equals("credit", StringComparison.OrdinalIgnoreCase)).ToList();
    }

    private void ShowDebitExpenses()
    {
        filteredExpenses = expenses.Where(e => e.ExpenseType.Equals("debit", StringComparison.OrdinalIgnoreCase)).ToList();
    }

    private void ShowAllExpenses()
    {
        filteredExpenses = expenses;
    }

    private void ApplyFilters()
    {
        filteredExpenses = expenses;

        if (minAmount.HasValue)
        {
            filteredExpenses = filteredExpenses.Where(e => e.Amount >= minAmount.Value).ToList();
        }

        if (maxAmount.HasValue)
        {
            filteredExpenses = filteredExpenses.Where(e => e.Amount <= maxAmount.Value).ToList();
        }

        if (startDate.HasValue)
        {
            filteredExpenses = filteredExpenses.Where(e => e.Date >= startDate.Value).ToList();
        }

        if (endDate.HasValue)
        {
            filteredExpenses = filteredExpenses.Where(e => e.Date <= endDate.Value).ToList();
        }

        if (!string.IsNullOrWhiteSpace(descriptionFilter))
        {
            filteredExpenses = filteredExpenses
                .Where(e => e.Description.Contains(descriptionFilter, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    private void ClearFilters()
    {
        minAmount = null;
        maxAmount = null;
        startDate = null;
        endDate = null;
        descriptionFilter = null;
        filteredExpenses = expenses;
    }

    private void SortByDate()
    {
        if (isDateAscending)
        {
            filteredExpenses = filteredExpenses.OrderBy(e => e.Date).ToList();
        }
        else
        {
            filteredExpenses = filteredExpenses.OrderByDescending(e => e.Date).ToList();
        }

        isDateAscending = !isDateAscending; // Toggle the sort order
    }

    private async Task NavigateToHome()
    {
        NavigationManager.NavigateTo("/home");
    }
}
