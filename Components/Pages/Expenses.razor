@page "/view-expenses"
@using DotnetCourseowork.Models
@inject UserService UserService
@inject NavigationManager NavigationManager

<div class="container my-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary">Manage Expenses</h3>
        <button class="btn btn-outline-primary" @onclick="NavigateToHome">
            Back to Home
        </button>
    </div>

    <!-- Filters Section -->
    <div class="card shadow-sm p-4 mb-4">
        <h5 class="mb-3 text-secondary">Filter Expenses</h5>

        <!-- Row-wise Filters with Counts -->
        <div class="row text-center mb-3">
            <div class="col-md-4">
                <button class="btn btn-outline-success w-100 rounded-pill" @onclick="ShowCreditExpenses">
                    Cash Inflow (@creditCount)
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-danger w-100 rounded-pill" @onclick="ShowDebitExpenses">
                    Cash Outflow (@debitCount)
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-dark w-100 rounded-pill" @onclick="ShowAllExpenses">
                    All Expenses (@totalCount)
                </button>
            </div>
        </div>

        <!-- Additional Filters -->
        <h6 class="text-secondary mb-3">Filter by Amount</h6>
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="number" class="form-control" placeholder="Min Amount" @bind="minAmount" />
            </div>
            <div class="col-md-6">
                <input type="number" class="form-control" placeholder="Max Amount" @bind="maxAmount" />
            </div>
        </div>

        <h6 class="text-secondary mb-3">Filter by Date</h6>
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="date" class="form-control" @bind="startDate" />
            </div>
            <div class="col-md-6">
                <input type="date" class="form-control" @bind="endDate" />
            </div>
        </div>

        <h6 class="text-secondary mb-3">Filter by Description</h6>
        <input type="text" class="form-control mb-3" placeholder="Search by Description" @bind="descriptionFilter" />

        <div class="row">
            <div class="col-md-6">
                <button class="btn btn-dark w-100 rounded-pill" @onclick="ApplyFilters">Apply Filters</button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-secondary w-100 rounded-pill" @onclick="ClearFilters">Clear Filters</button>
            </div>
        </div>
    </div>

    <!-- Sort by Date Button -->
    <button class="btn btn-dark mb-3 rounded-pill" @onclick="SortByDate">Sort by Date</button>

    <!-- Expenses Table -->
    <div class="card shadow-sm p-3">
        <h5 class="text-secondary mb-3">Expense Details</h5>
        <table class="table table-bordered table-striped">
            <thead class="thead-dark">
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Expense Type</th>
                    <th>Expense Tag</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (filteredExpenses.Count > 0)
                {
                    @foreach (var expense in filteredExpenses)
                    {
                        <tr>
                            <td>@expense.Date.ToString()</td>
                            <td>@expense.Description</td>
                            <td>$@expense.Amount</td>
                            <td>@expense.ExpenseType</td>
                            <td>@expense.ExpenseTag</td>
                            <td>
                                <button class="btn btn-danger btn-sm" @onclick="() => ConfirmDelete(expense)">Delete</button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center">No expenses available.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private List<Expense> expenses = new List<Expense>();
    private List<Expense> filteredExpenses = new List<Expense>();

    private decimal? minAmount;
    private decimal? maxAmount;
    private DateTime? startDate;
    private DateTime? endDate;
    private string descriptionFilter;

    private bool isDateAscending = true;

    private int creditCount;
    private int debitCount;
    private int totalCount;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            expenses = UserService.GetUserExpenses();
            filteredExpenses = expenses;
            UpdateCounts();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching expenses: {ex.Message}");
        }
    }

    private void ShowCreditExpenses()
    {
        filteredExpenses = expenses.Where(e => e.ExpenseType.Equals("credit", StringComparison.OrdinalIgnoreCase)).ToList();
        UpdateCounts();
    }

    private void ShowDebitExpenses()
    {
        filteredExpenses = expenses.Where(e => e.ExpenseType.Equals("debit", StringComparison.OrdinalIgnoreCase)).ToList();
        UpdateCounts();
    }

    private void ShowAllExpenses()
    {
        filteredExpenses = expenses;
        UpdateCounts();
    }

    private void ApplyFilters()
    {
        filteredExpenses = expenses;

        if (minAmount.HasValue)
            filteredExpenses = filteredExpenses.Where(e => e.Amount >= minAmount.Value).ToList();

        if (maxAmount.HasValue)
            filteredExpenses = filteredExpenses.Where(e => e.Amount <= maxAmount.Value).ToList();

        if (startDate.HasValue)
            filteredExpenses = filteredExpenses.Where(e => e.Date >= startDate.Value).ToList();

        if (endDate.HasValue)
            filteredExpenses = filteredExpenses.Where(e => e.Date <= endDate.Value).ToList();

        if (!string.IsNullOrWhiteSpace(descriptionFilter))
            filteredExpenses = filteredExpenses.Where(e => e.Description.Contains(descriptionFilter, StringComparison.OrdinalIgnoreCase)).ToList();

        UpdateCounts();
    }

    private void ClearFilters()
    {
        minAmount = null;
        maxAmount = null;
        startDate = null;
        endDate = null;
        descriptionFilter = null;
        filteredExpenses = expenses;
        UpdateCounts();
    }

    private void SortByDate()
    {
        filteredExpenses = isDateAscending
            ? filteredExpenses.OrderBy(e => e.Date).ToList()
            : filteredExpenses.OrderByDescending(e => e.Date).ToList();

        isDateAscending = !isDateAscending;
    }

    private async Task NavigateToHome() => NavigationManager.NavigateTo("/home");

    private void ConfirmDelete(Expense expense)
    {
        if (confirm($"Are you sure you want to delete the expense: {expense.Description}?"))
        {
            DeleteExpense(expense);
        }
    }

    private void DeleteExpense(Expense expense)
    {
        expenses.Remove(expense);
        filteredExpenses.Remove(expense);
        UpdateCounts();
    }

    private void UpdateCounts()
    {
        creditCount = expenses.Count(e => e.ExpenseType.Equals("credit", StringComparison.OrdinalIgnoreCase));
        debitCount = expenses.Count(e => e.ExpenseType.Equals("debit", StringComparison.OrdinalIgnoreCase));
        totalCount = expenses.Count;
    }

    private bool confirm(string message)
    {
        return true; // Replace with a proper JS Interop confirmation dialog
    }
}
